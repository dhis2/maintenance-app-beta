name: Generate Contracts and Sync to contracts repo

on:
    pull_request:
        types: [opened, synchronize, reopened]

jobs:
    generate-and-sync:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repo
              uses: actions/checkout@v2

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 20
                  cache: yarn

            - name: Install dependencies
              run: yarn install --frozen-lockfile

            - name: Run contracts script
              run: yarn contracts

            # Detect whether contracts/ has changes
            - name: Check for contract changes
              id: diff
              run: |
                  if git diff --quiet HEAD -- contracts; then
                    echo "changed=false" >> $GITHUB_OUTPUT
                  else
                    echo "changed=true" >> $GITHUB_OUTPUT
                  fi

            - name: Clone contracts repo and push branch
              if: steps.diff.outputs.changed == 'true'
              run: |
                  git config --global user.name "github-actions[bot]"
                  git config --global user.email "github-actions[bot]@users.noreply.github.com"

                  git clone https://x-access-token:${{ secrets.DHIS2_BOT_GITHUB_TOKEN }}@github.com/dhis2/dhis2-api-contracts.git
                  cd dhis2-api-contracts

                  BRANCH_NAME="auto/contracts-update-${{ github.event.pull_request.number }}"
                  if git ls-remote --exit-code --heads origin "$BRANCH_NAME" > /dev/null; then
                    echo "Branch $BRANCH_NAME exists, checking it out"
                    git checkout "$BRANCH_NAME"
                  else
                    echo "Branch $BRANCH_NAME does not exist, creating it"
                    git checkout -b "$BRANCH_NAME"
                  fi
                  cp -r ../contracts ./contracts/maintenance-app

                  git add .
                  if git diff --cached --quiet; then
                    echo "No changes to commit after copy."
                    exit 0
                  fi

                  git commit -m "Auto-update contracts from Maintenance app PR #${{ github.event.pull_request.number }}"
                  git push origin $BRANCH_NAME

            - name: Create Pull Request in contract repo
              if: steps.diff.outputs.changed == 'true'
              run: |
                  cd dhis2-api-contracts
                  BRANCH_NAME="auto/contracts-update-${{ github.event.pull_request.number }}"
                  gh auth login --with-token <<< "${{ secrets.DHIS2_BOT_GITHUB_TOKEN }}"

                  # Check if a PR already exists for this branch
                  if gh pr list --head "$BRANCH_NAME" --base main --json number --jq '.[0].number' | grep -q .; then
                    echo "PR already exists for branch $BRANCH_NAME, skipping creation."
                  else
                    gh pr create \
                      --base main \
                      --head "$BRANCH_NAME" \
                      --title "Auto PR: Contracts from maintenance app PR #${{ github.event.pull_request.number }}" \
                      --body "This PR was automatically created from a pull request in maintenance app." \
                      --reviewer dhis2/platform-backend
                  fi
